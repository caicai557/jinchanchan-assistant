name: Smoke Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Mac/Ubuntu 门禁测试 (Python 3.12)
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Create venv and install dependencies
        run: |
          python -m venv venv
          ./venv/bin/pip install --upgrade pip
          ./venv/bin/pip install -e ".[dev,control,ocr]"

      - name: Ruff check
        run: ./venv/bin/ruff check .

      - name: Ruff format check
        run: ./venv/bin/ruff format --check .

      - name: Mypy type check
        run: ./venv/bin/mypy .

      - name: Run pytest
        run: ./venv/bin/pytest -v

  # Windows 模块导入验证 (无设备依赖)
  windows-import-test:
    runs-on: windows-latest
    env:
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Create venv and install dependencies
        shell: bash
        run: |
          python -m venv venv
          ./venv/Scripts/python -m pip install -e ".[dev,windows]"

      - name: Verify Windows modules can be imported
        shell: bash
        run: |
          ./venv/Scripts/python -c "
          from platforms.windows_emulator import WindowsEmulatorAdapter
          from platforms.windows_emulator.adb_controller import ADBController
          print('OK')
          "

      - name: Run pytest (exclude Mac-specific tests)
        shell: bash
        run: ./venv/Scripts/python -m pytest -v --ignore=tests/test_debug_ui.py

  # 模板完整性检查
  template-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m venv venv
          ./venv/bin/pip install -e ".[dev]"

      - name: Validate S13 templates
        run: |
          ./venv/bin/python -c "
          from pathlib import Path
          from core.vision.template_registry import TemplateRegistry

          # 检查 S13 导入目录
          s13_dir = Path('resources/templates/s13_imported')
          assert s13_dir.exists(), f'S13 导入目录不存在: {s13_dir}'

          png_files = list(s13_dir.glob('*.png'))
          print(f'S13 模板数量: {len(png_files)}')
          assert len(png_files) == 99, f'预期 99 个模板，实际 {len(png_files)} 个'

          # 检查映射文件
          mapping_file = Path('resources/templates/s13_mapping.json')
          assert mapping_file.exists(), f'映射文件不存在: {mapping_file}'

          # 检查注册表
          registry = TemplateRegistry()
          count = registry.count_s13_imported()
          print(f'注册表统计 S13 模板: {count}')
          assert count == 99, f'注册表统计不匹配: {count}'

          print('✓ 模板验证通过')
          "

      - name: Run recognition tests
        run: ./venv/bin/pytest tests/test_recognition.py -v

  # 离线回放回归测试
  offline-replay:
    runs-on: ubuntu-latest
    needs: [lint-and-test]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m venv venv
          ./venv/bin/pip install --upgrade pip
          ./venv/bin/pip install -e ".[dev]"

      - name: Generate fixtures
        run: |
          ./venv/bin/python tests/fixtures/generate_fixtures.py
          ls -la tests/fixtures/screens/

      - name: Run offline replay tests
        run: |
          ./venv/bin/pytest tests/test_offline_replay.py -v

      - name: Generate replay artifacts
        run: |
          mkdir -p artifacts/replay
          ./venv/bin/python -c "
          import json
          from pathlib import Path
          import sys
          sys.path.insert(0, 'tests')
          from test_offline_replay import OfflineReplayTest, FIXTURES_DIR

          tester = OfflineReplayTest(seed=42)
          results = []
          for fixture in FIXTURES_DIR.glob('*.png'):
              result = tester.replay_fixture(fixture)
              results.append({
                  'fixture': result.fixture_name,
                  'extracted_fields': result.extracted_fields,
                  'actions': result.actions,
                  'validation_passed': result.validation_passed,
              })

          with open('artifacts/replay/replay_results.json', 'w') as f:
              json.dump({
                  'version': '1.0',
                  'seed': 42,
                  'fixtures_tested': len(results),
                  'results': results
              }, f, indent=2, ensure_ascii=False)

          print(f'Generated replay artifacts for {len(results)} fixtures')
          "

      - name: Upload replay artifacts
        uses: actions/upload-artifact@v4
        with:
          name: replay-artifacts
          path: artifacts/replay/
          retention-days: 7

  # macOS Lite 构建
  build-macos-lite:
    runs-on: macos-latest
    needs: [lint-and-test, template-validation]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies (lite)
        run: |
          python -m venv venv
          ./venv/bin/pip install --upgrade pip
          ./venv/bin/pip install -e ".[dev,control,mac,build]"

      - name: Build with PyInstaller (lite)
        run: |
          chmod +x scripts/build_mac.sh
          ./scripts/build_mac.sh --flavor lite

      - name: Upload macOS lite artifact
        uses: actions/upload-artifact@v4
        with:
          name: jinchanchan-macos-lite
          path: dist/金铲铲助手-lite
          retention-days: 30

  # macOS Full 构建
  build-macos-full:
    runs-on: macos-latest
    needs: [lint-and-test, template-validation]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies (full)
        run: |
          python -m venv venv
          ./venv/bin/python -m pip install --upgrade pip
          ./venv/bin/pip install -e ".[dev,control,full,mac,build]"

      - name: Build with PyInstaller (full)
        run: |
          chmod +x scripts/build_mac.sh
          ./scripts/build_mac.sh --flavor full

      - name: Verify Full capabilities
        run: |
          ./dist/金铲铲助手 --capabilities --require-full

      - name: Generate capabilities.txt
        run: |
          mkdir -p artifacts artifacts/replay
          ./dist/金铲铲助手 --capabilities > artifacts/capabilities.txt

      - name: Run offline replay self-test
        run: |
          ./dist/金铲铲助手 --self-test offline-replay
          mv replay_results.json artifacts/replay/

      - name: Upload macOS full artifact
        uses: actions/upload-artifact@v4
        with:
          name: jinchanchan-macos-full
          path: dist/金铲铲助手
          retention-days: 30

      - name: Upload Full artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-artifacts-macos
          path: |
            artifacts/capabilities.txt
            artifacts/replay/
          retention-days: 7

  # Windows build
  build-windows:
    runs-on: windows-latest
    needs: [lint-and-test, windows-import-test]
    env:
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          python -m venv venv
          .\venv\Scripts\python -m pip install -e ".[dev,windows,build]"

      - name: Build with PyInstaller
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          .\scripts\build_win.ps1

      - name: Run product acceptance test
        shell: pwsh
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          .\scripts\smoke_dist_win.ps1 -SkipBuild

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: jinchanchan-windows
          path: dist/jinchanchan-assistant.exe
          retention-days: 30

      - name: Upload smoke test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-artifacts-windows
          path: artifacts/smoke/
          retention-days: 7
